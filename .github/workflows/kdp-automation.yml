name: KDP Auto Publishing Pipeline
# Living Book Engine v2 Ã— KDPè‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

on:
  schedule:
    - cron: '0 6 * * *'  # æ¯Žæ—¥06:00 JST (21:00 UTCå‰æ—¥)
  push:
    paths: 
      - 'docs/**/*.md'
      - 'content-generation-pipeline.js'
  workflow_dispatch:
    inputs:
      topic:
        description: 'æ›¸ç±ãƒˆãƒ”ãƒƒã‚¯'
        required: false
        default: 'auto'
      category:
        description: 'ã‚«ãƒ†ã‚´ãƒª'
        required: false
        default: 'self-help'

env:
  NODE_VERSION: '18'
  BOOK_OUTPUT_DIR: 'generated-books'

jobs:
  # Job 1: AI ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
  ai-content-generation:
    runs-on: ubuntu-latest
    outputs:
      book-path: ${{ steps.generate.outputs.book-path }}
      book-title: ${{ steps.generate.outputs.book-title }}
      quality-score: ${{ steps.generate.outputs.quality-score }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install Dependencies
        run: |
          npm ci
          npm install @anthropic-ai/sdk openai
          
      - name: ðŸ¤– Generate AI Content
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ðŸš€ AIæ›¸ç±ç”Ÿæˆé–‹å§‹..."
          node content-generation-pipeline.js
          
          # ç”Ÿæˆçµæžœã®ç¢ºèª
          if [ -d "docs/generated-books" ]; then
            LATEST_BOOK=$(ls -t docs/generated-books | head -n1)
            echo "book-path=docs/generated-books/$LATEST_BOOK" >> $GITHUB_OUTPUT
            
            # ã‚¿ã‚¤ãƒˆãƒ«æŠ½å‡º
            TITLE=$(grep -m1 "^# " "docs/generated-books/$LATEST_BOOK/index.md" | sed 's/^# //')
            echo "book-title=$TITLE" >> $GITHUB_OUTPUT
            
            echo "âœ… æ›¸ç±ç”Ÿæˆå®Œäº†: $TITLE"
          else
            echo "âŒ æ›¸ç±ç”Ÿæˆå¤±æ•—"
            exit 1
          fi
          
      - name: ðŸ“Š Quality Assessment
        id: quality
        run: |
          # å“è³ªã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
          BOOK_PATH="${{ steps.generate.outputs.book-path }}"
          WORD_COUNT=$(find "$BOOK_PATH" -name "*.md" -exec wc -w {} + | tail -n1 | awk '{print $1}')
          FILE_COUNT=$(find "$BOOK_PATH" -name "*.md" | wc -l)
          
          # å“è³ªã‚¹ã‚³ã‚¢è¨ˆç®—
          if [ $WORD_COUNT -gt 40000 ] && [ $FILE_COUNT -gt 10 ]; then
            QUALITY_SCORE=9
          elif [ $WORD_COUNT -gt 30000 ] && [ $FILE_COUNT -gt 8 ]; then
            QUALITY_SCORE=8
          else
            QUALITY_SCORE=7
          fi
          
          echo "quality-score=$QUALITY_SCORE" >> $GITHUB_OUTPUT
          echo "ðŸ“Š å“è³ªã‚¹ã‚³ã‚¢: $QUALITY_SCORE/10"
          echo "ðŸ“ æ–‡å­—æ•°: $WORD_COUNT words"
          echo "ðŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $FILE_COUNT files"
          
      - name: ðŸ’¾ Commit Generated Content
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add docs/generated-books/
          if git diff --cached --quiet; then
            echo "å¤‰æ›´ãªã— - ã‚¹ã‚­ãƒƒãƒ—"
          else
            git commit -m "ðŸ“š AIç”Ÿæˆæ›¸ç±è¿½åŠ : ${{ steps.generate.outputs.book-title }}"
            git push
          fi

  # Job 2: VitePress ãƒ“ãƒ«ãƒ‰ & å“è³ªç®¡ç†
  vitepress-build:
    needs: ai-content-generation
    runs-on: ubuntu-latest
    if: needs.ai-content-generation.outputs.quality-score >= '8'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: main  # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆå–å¾—
          
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install Dependencies
        run: npm ci
        
      - name: ðŸ—ï¸ Build VitePress
        run: |
          echo "ðŸ—ï¸ VitePress ãƒ“ãƒ«ãƒ‰é–‹å§‹..."
          npm run build
          
      - name: ðŸ“‹ Generate Book Manifest
        run: |
          BOOK_PATH="${{ needs.ai-content-generation.outputs.book-path }}"
          cat > book-manifest.json << EOF
          {
            "title": "${{ needs.ai-content-generation.outputs.book-title }}",
            "path": "$BOOK_PATH",
            "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "quality_score": ${{ needs.ai-content-generation.outputs.quality-score }},
            "status": "ready_for_conversion",
            "formats_target": ["epub", "pdf", "mobi"]
          }
          EOF
          
      - name: ðŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vitepress-build
          path: |
            .vitepress/dist/
            book-manifest.json
            ${{ needs.ai-content-generation.outputs.book-path }}/

  # Job 3: ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå¤‰æ› (Markdown â†’ EPUB/PDF)
  format-conversion:
    needs: [ai-content-generation, vitepress-build]
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: vitepress-build
          
      - name: ðŸ”§ Setup Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex
          
      - name: ðŸ“– Convert to EPUB
        run: |
          BOOK_PATH="${{ needs.ai-content-generation.outputs.book-path }}"
          BOOK_TITLE="${{ needs.ai-content-generation.outputs.book-title }}"
          
          echo "ðŸ“– EPUBå¤‰æ›é–‹å§‹..."
          
          # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          cat > metadata.yaml << EOF
          title: $BOOK_TITLE
          author: AI Generated Content
          date: $(date +%Y-%m-%d)
          language: ja
          EOF
          
          # Markdownçµ±åˆ
          find "$BOOK_PATH" -name "*.md" -not -name "index.md" | sort | xargs cat > combined.md
          
          # EPUBç”Ÿæˆ
          pandoc metadata.yaml combined.md \
            --from markdown \
            --to epub \
            --output "$BOOK_TITLE.epub" \
            --epub-cover-image=cover.png \
            --toc
            
          echo "âœ… EPUBç”Ÿæˆå®Œäº†"
          
      - name: ðŸ“„ Convert to PDF
        run: |
          BOOK_TITLE="${{ needs.ai-content-generation.outputs.book-title }}"
          
          echo "ðŸ“„ PDFå¤‰æ›é–‹å§‹..."
          
          pandoc combined.md \
            --from markdown \
            --to pdf \
            --output "$BOOK_TITLE.pdf" \
            --pdf-engine=xelatex \
            --toc \
            --variable mainfont="Noto Sans CJK JP"
            
          echo "âœ… PDFç”Ÿæˆå®Œäº†"
          
      - name: ðŸŽ¨ Generate Cover Image
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          BOOK_TITLE="${{ needs.ai-content-generation.outputs.book-title }}"
          
          # ã‚«ãƒãƒ¼ç”»åƒç”Ÿæˆï¼ˆDALL-E 3ä½¿ç”¨ï¼‰
          node -e "
            const OpenAI = require('openai');
            const fs = require('fs');
            
            const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
            
            (async () => {
              try {
                const response = await openai.images.generate({
                  model: 'dall-e-3',
                  prompt: 'Professional book cover design for \"$BOOK_TITLE\", modern minimalist style, high quality',
                  size: '1024x1024',
                  quality: 'standard',
                  n: 1
                });
                
                const imageUrl = response.data[0].url;
                console.log('Cover generated:', imageUrl);
                
                // ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå®Ÿè£…ç°¡ç•¥åŒ–ï¼‰
                console.log('âœ… ã‚«ãƒãƒ¼ç”»åƒç”Ÿæˆå®Œäº†');
              } catch (error) {
                console.error('ã‚«ãƒãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error.message);
              }
            })();
          "
          
      - name: ðŸ“¤ Upload Converted Files
        uses: actions/upload-artifact@v4
        with:
          name: kdp-ready-files
          path: |
            *.epub
            *.pdf
            *.png

  # Job 4: KDPè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆå®Ÿè£…ã¯è¤‡é›‘ãªãŸã‚éª¨çµ„ã¿ã®ã¿ï¼‰
  kdp-upload:
    needs: [ai-content-generation, format-conversion]
    runs-on: ubuntu-latest
    if: needs.ai-content-generation.outputs.quality-score >= '9'
    
    steps:
      - name: ðŸ“¥ Download KDP Files
        uses: actions/download-artifact@v4
        with:
          name: kdp-ready-files
          
      - name: ðŸš€ Upload to KDP (Mock)
        env:
          KDP_USERNAME: ${{ secrets.KDP_USERNAME }}
          KDP_PASSWORD: ${{ secrets.KDP_PASSWORD }}
        run: |
          echo "ðŸš€ KDPè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æº–å‚™ä¸­..."
          echo "ðŸ“š æ›¸ç±: ${{ needs.ai-content-generation.outputs.book-title }}"
          echo "ðŸ“Š å“è³ªã‚¹ã‚³ã‚¢: ${{ needs.ai-content-generation.outputs.quality-score }}/10"
          
          # KDP APIé€£æºï¼ˆå®Ÿè£…å¿…è¦ï¼‰
          # ç¾åœ¨ã¯ãƒ¢ãƒƒã‚¯è¡¨ç¤ºã®ã¿
          echo "âœ… KDPã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰"
          
      - name: ðŸ“Š Success Notification
        run: |
          echo "ðŸŽ‰ æ—¥æ¬¡KDPè‡ªå‹•å‡ºç‰ˆå®Œäº†!"
          echo "ðŸ“– æ›¸ç±å: ${{ needs.ai-content-generation.outputs.book-title }}"
          echo "ðŸ“Š å“è³ªã‚¹ã‚³ã‚¢: ${{ needs.ai-content-generation.outputs.quality-score }}/10"
          echo "ðŸ• å‡¦ç†æ™‚é–“: $(date)"

  # Job 5: åˆ†æžãƒ»ãƒ¬ãƒãƒ¼ãƒˆ
  analytics-report:
    needs: [ai-content-generation, vitepress-build, format-conversion]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Daily Report
        run: |
          cat > daily-report.md << EOF
          # ðŸ“Š KDPè‡ªå‹•åŒ– æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ
          
          **æ—¥ä»˜**: $(date +%Y-%m-%d)
          **å®Ÿè¡Œæ™‚åˆ»**: $(date +%H:%M:%S)
          
          ## ç”Ÿæˆçµæžœ
          - **æ›¸ç±ã‚¿ã‚¤ãƒˆãƒ«**: ${{ needs.ai-content-generation.outputs.book-title || 'N/A' }}
          - **å“è³ªã‚¹ã‚³ã‚¢**: ${{ needs.ai-content-generation.outputs.quality-score || 'N/A' }}/10
          - **ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: ${{ needs.ai-content-generation.outputs.book-path || 'N/A' }}
          
          ## ã‚¸ãƒ§ãƒ–å®Ÿè¡ŒçŠ¶æ³
          - **AIç”Ÿæˆ**: ${{ needs.ai-content-generation.result }}
          - **VitePress**: ${{ needs.vitepress-build.result }}
          - **å¤‰æ›**: ${{ needs.format-conversion.result }}
          
          ## æ¬¡å›žæ”¹å–„ç‚¹
          - å“è³ªã‚¹ã‚³ã‚¢å‘ä¸Šæ–½ç­–
          - å‡¦ç†æ™‚é–“æœ€é©åŒ–
          - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
          
          ---
          *è‡ªå‹•ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ - Living Book Engine v2*
          EOF
          
          echo "ðŸ“‹ æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
          cat daily-report.md

# Last Updated: 2025-06-29 04:23:00 JST